<!DOCTYPE html>
<html>

<head>
  <title>Rebate Calculator</title>

  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="../css/bootstrap-theme.css">
  <link rel="stylesheet" href="../css/mbr-ls.css">

  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script src="../js/jquery-3.1.0.js"></script>
  <script src="../js/boostrap.js"></script>
  <script>if (window.module) module = window.module;</script>

  <script>
    const {ipcRenderer} = require('electron')
    const {toFloat, floatToString, joinDate} = require('./../../lib/util.js')

    function lsMbr() {
      ipcRenderer.send('ls-mbr', null)
    }

    function setWorkingDate() {
      let m = parseInt($('#working-date-month').val())
      let y = parseInt($('#working-date-year').val())
      let d = null
      $('#working-date-day li').each((idx, e) => {
        e = $(e)
        if (e.hasClass('active'))
          d = (idx + 1) * 10
      })
      ipcRenderer.send('set-working-date', joinDate(y, m, d))
    }

    function getWorkingDate() {
      ipcRenderer.send('get-working-date', null)
    }

    function getMbrProfit() {
      ipcRenderer.send('get-mbr-profit', null)
    }

    function showMbrInfo(_id) {  // show create new member form if _id is null.
      ipcRenderer.send('show-mbr-info', _id)
    }

    function selectDay(d) {
      let dayElement = $('#working-date-day li')
      for (let i=0; i<3; i++) {
        e = $(dayElement[i])
        if (d == i) {
          if (e.hasClass('active'))
            return
          e.addClass('active')
        } else
          e.removeClass('active')
      }
      setWorkingDate()
    }

    ipcRenderer.on('ls-mbr', (evt, mbrs) => {
      mbrsLen = mbrs.length
      if (!mbrsLen)
        $('#mbr-ls-table-body').html('<tr><td colspan="11">No records.</td></tr>')

      else {
        let profitPct = toFloat($('#mbr-profit').val(), 2)
        let body = ''

        for (mbr of mbrs) {
          let profit = toFloat(toFloat(mbr.mbrPackage, 2) * profitPct / 100, 2)
          if (isNaN(profit))
            profit = 'N/A'
          else
            profit = floatToString(profit, 2)

          body += `
            <tr class="mbr-tr" mbrId="${mbr._id}">
              <td><a href="javascript:showMbrInfo('${mbr._id}')">${mbr.mbrName}</a></td>
              <td>${mbr.mbrId}</td>
              <td>${mbr.mbrHp}</td>
              <td>${mbr.mbrIc}</td>
              <td>${mbr.mbrEmail}</td>
              <td>${mbr.mbrBankName}</td>
              <td>${mbr.mbrBankAcc}</td>
              <td>${mbr.mbrJoinDate}</td>
              <td>${floatToString(mbr.mbrPackage, 2)}</td>
              <td>${mbr.mbrRemark}</td>
              <td>${profit}</td>
            </tr>`
        }

        $('#mbr-ls-table-body').html(body)

        $('.mbr-tr').dblclick(function() {
          let _id = $(this).attr('mbrId')
          ipcRenderer.send('show-mbr-rebate', _id)
        })
      }
    })

    ipcRenderer.on('get-mbr-profit', (evt, profit) => {
      $('#mbr-profit').val(floatToString(profit, 2))
      lsMbr()
    })

    ipcRenderer.on('get-working-date', (evt, d) => {
      $('#working-date-month').val(d.m)
      $('#working-date-year').val(d.y)
      let dayElement = $('#working-date-day li')
      let j = (d.d / 10) - 1
      for (let i=0; i<3; i++) {
        let e = $(dayElement[i])
        if (i == j)
          e.addClass('active')
        else
          e.removeClass('active')
      }
    })
    
    window.onload = function () {
      $('#working-date-month').change(setWorkingDate)
      $('#working-date-year').change(setWorkingDate)

      getWorkingDate()
      getMbrProfit()
    }
  </script>

</head>

<body>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <span class="navbar-brand">Working Date</span>
      </div>
      <ul class="nav navbar-nav" id="working-date-day">
        <li><a href="javascript:selectDay(0)">10</a></li>
        <li><a href="javascript:selectDay(1)">20</a></li>
        <li><a href="javascript:selectDay(2)">30</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="javascript:void(0)"><select class="working-date-select" id="working-date-month"><!-- INSERT MONTHS HERE --></select></a></li>
        <li><a href="javascript:void(0)"><select class="working-date-select" id="working-date-year"><!-- INSERT YEARS HERE --></select></a></li>
      </ul>
    </div>
  </nav>
  <script>
    let monthNames = [ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ]
    let cnt = ''
    for (let i=1; i<=12; i++)
      cnt += `<option value="${i}">${monthNames[i-1]}</option>`
    $('#working-date-month').html(cnt)

    let y = (new Date()).getFullYear()
    cnt = ''
    for (let i=y-5; i<=y+5; i++)
      cnt += `<option value="${i}">${i}</option>`
    $('#working-date-year').html(cnt)
  </script>

  <ol class="breadcrumb">
    <li><a href="javascript:showMbrInfo(null)">New Member</a></li>
    <li><a href="javascript:showMbrInfo(null)">Print</a></li>
  </ol>

  <table class="table table-condensed table-hover">
    <thead>
      <tr>
        <th>Name</th>
        <th>ID</th>
        <th>HP No</th>
        <th>IC No</th>
        <th>Email</th>
        <th>Bank Name</th>
        <th>Bank Acc</th>
        <th>Join Date</th>
        <th>Package</th>
        <th>Remark</th>
        <th><input id="mbr-profit" placeholder="Profit" type="number">%</th>
      </tr>
    </thead>
    <tbody id="mbr-ls-table-body">
      <!-- INSERT MBR LS HERE -->
    </tbody>
  </table>
  <script>
    let mbrProfit = $('#mbr-profit') 
    mbrProfit.focusout(evt => {
      let parsedInput = toFloat(mbrProfit.val(), 2)
      mbrProfit.val(floatToString(parsedInput, 2))
      ipcRenderer.send('set-mbr-profit', parsedInput)
      lsMbr()
    })
    mbrProfit.keypress(evt => {
      if (evt.which == 13)
        mbrProfit.blur()
    })
    mbrProfit.focus(function(){
      this.select()
    })
  </script>
</body>

</html>