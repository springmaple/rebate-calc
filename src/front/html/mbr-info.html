<!DOCTYPE html>
<html>

<head>
  <title>Member</title>

  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="../css/bootstrap-theme.css">
  <link rel="stylesheet" href="../css/mbr-info.css">

  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script src="../js/jquery-3.1.0.js"></script>
  <script src="../js/boostrap.js"></script>
  <script>if (window.module) module = window.module;</script>
  <script>
    const {ipcRenderer} = require('electron')
    const {getParamByName, floatToString} = require('./../../lib/util.js')
    const map = {
      mbrName: 'mbr-name',
      mbrId: 'mbr-id',
      mbrHp: 'mbr-hp', 
      mbrIc: 'mbr-ic', 
      mbrEmail: 'mbr-email',
      mbrBankName: 'mbr-bank-name',
      mbrBankAcc: 'mbr-bank-acc',
      mbrJoinDate: 'mbr-join-date',
      mbrPackage: 'mbr-package',
      mbrRemark: 'mbr-remark'
    }
    const _id = getParamByName('_id', window.location.href)
    
    var _mbr = null
    var cnlUpdMbr = window.close

    function rmErr() {
      $('#form-error').html('')
    }

    function prevalidate() {
      if ($('#mbr-name').val().length == 0) {
        $('#form-error').html(`
          <div class="alert alert-danger">
            <a href="javascript:rmErr()" class="close" aria-label="close">&times;</a>
            <strong>Validation!</strong> Fill in member name.
          </div>`)
        return false
      }
      let mbrPackage = $('#mbr-package') 
      mbrPackage.val(floatToString(mbrPackage.val()))
      return true
    }

    function newMbr() {
      if (!prevalidate())
        return false
      let mbrToIns = {}
      for (let key in map)
        mbrToIns[key] = $(`#${map[key]}`).val()
      ipcRenderer.send('new-mbr', mbrToIns)
      cnlUpdMbr()
    }

    function updMbr() {
      if (!prevalidate())
        return false
      
      let mbrToUpd = {}
      for (let key in map) {
        let value = $(`#${map[key]}`).val() 
        if (value != _mbr[key])
          mbrToUpd[key] = value
      }

      if (!$.isEmptyObject(mbrToUpd))
        ipcRenderer.send('upd-mbr', {_id: _id, mbr: mbrToUpd})

      cnlUpdMbr()
    }

    ipcRenderer.on('get-mbr', (evt, mbr) => {
      _mbr = mbr
      for (let key in map)
        $(`#${map[key]}`).val(mbr[key]) 
    })

    window.onload = function () {
      let btnTxt = null
      if (_id) {
        ipcRenderer.send('get-mbr', _id)
        btnTxt = `<button onclick="updMbr()" class="btn btn-primary">Update</button>
                  <button onclick="cnlUpdMbr()" class="btn btn-default">Cancel</button>`
      } else
        btnTxt = `<button onclick="newMbr()" class="btn btn-primary">Create Member</button>`
      $('#form-btn').html(btnTxt)

      let mbrPackage = $('#mbr-package') 
      mbrPackage.focusout(evt => {
        mbrPackage.val(floatToString(mbrPackage.val(), 2))
      })

      let mbrName = $('#mbr-name') 
      mbrName.focusout(evt => {
        if (mbrName.val().length > 0)
          rmErr()
      })
    }
  </script>

</head>

<body>
  <div id="mbr-navibar">
    <script>
      if (_id) {
        $('#mbr-navibar').html(`
          <ul class="nav nav-tabs nav-justified">
            <li class="active"><a href="#">Info</a></li>
            <li><a href="mbr-rebate.html?_id=${_id}">Calculator</a></li>
          </ul>`)
      }
    </script>
  </div>
  
  <div class="container">
    <div id="form-error">
      <!-- INSERT ERROR HERE -->
    </div>

    <form class="form-horizontal" onsubmit="return false">
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-name">Name:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-name" placeholder="Enter name">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-id">ID:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-id" placeholder="Enter id">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-hp">Hp No:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-hp" placeholder="Enter hp no">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-ic">IC:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-ic" placeholder="Enter ic">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-email">Email:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-email" placeholder="Enter email">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-bank-name">Bank Name:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-bank-name" placeholder="Enter bank name">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-bank-acc">Bank Acc:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-bank-acc" placeholder="Enter bank acc">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-join-date">Join Date:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-join-date" placeholder="Enter join date">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-package">Package:</label>
        <div class="col-sm-10">
          <input type="text" class="form-control" id="mbr-package" placeholder="Enter package">
        </div>
      </div>
      <div class="form-group">
        <label class="control-label col-sm-2" for="mbr-remark">Remark:</label>
        <div class="col-sm-10">
          <textarea class="form-control" id="mbr-remark" rows="2" placeholder="Enter remark"></textarea>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10" id="form-btn">
          <!-- INSERT BTN HERE -->
        </div>
      </div>
    </form>
  </div>

</body>

</html>