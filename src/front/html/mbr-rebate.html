<!DOCTYPE html>
<html>

<head>
  <title>Calculator</title>
  <link rel="stylesheet" href="../css/bootstrap.css">
  <link rel="stylesheet" href="../css/bootstrap-theme.css">
  <link rel="stylesheet" href="../css/mbr-rebate.css">

  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script src="../js/jquery-3.1.0.js"></script>
  <script src="../js/boostrap.js"></script>
  <script>if (window.module) module = window.module;</script>
  <script>
    const {getParamByName, floatToString, toFloat} = require('./../../lib/util.js')
    const {ipcRenderer} = require('electron')
    const _id = getParamByName('_id', window.location.href)
    const map = {
      mbrName: 'mbr-name',
      mbrEmail: 'mbr-email',
      mbrBankName: 'mbr-bank-name',
      mbrBankAcc: 'mbr-bank-acc',
      mbrPackage: 'mbr-package'
    }

    function selectMbrDate(i, j, selectedVal) {
      let rebateMbrDatesId = `input:checkbox[name="rebate-mbr-date-${i}-${j}"]`
      let rebateMbrDates = $(rebateMbrDatesId)
      for (let i=0; i<3; i++) {
        let e = $(rebateMbrDates[i])
        if (selectedVal == e.attr('val'))
          e.parent().toggleClass('active')
        else
          e.parent().removeClass('active')
      }
    }

    function updSubtotal(i, save) {
      i = parseInt(i)
      let data = {10: 0, 20: 0, 30: 0}   
      let dataCount = {10: 0, 20: 0, 30: 0}

      let rebateMbrLs = []
      let rebateMbrSave = {mbr_id: _id, mbrPct: i, mbr: rebateMbrLs}
      let rebatePackageLs = []
      let rebatePackageSave = {mbr_id: _id, mbrPct: i, mbrPackage: rebatePackageLs}

      for (let j=0; j<30; j++) {
        let rebateMbrDatesId = `input:checkbox[name="rebate-mbr-date-${i}-${j}"]`
        let rebateMbrNameId = `#rebate-mbr-name-${i}-${j}`
        let rebateMbrPackageId = `#rebate-mbr-package-${i}-${j}`

        let mbrPackage = toFloat($(rebateMbrPackageId).val(), 2)
        let mbrDate = null
        let rebateMbrDates = $(rebateMbrDatesId)
        for (let k=0; k<3; k++) {
          let e = $(rebateMbrDates[k])
          if (e.parent().hasClass('active')) {
            mbrDate = e.attr('val')
            break
          }
        }

        let e = $(`#rebate-mbr-${i}-${j}`)
        e.removeClass('rebate-panel-active-10 rebate-panel-active-20 rebate-panel-active-30')
        if (!isNaN(mbrPackage) && mbrDate !== null) {
          e.addClass(`rebate-panel-active-${mbrDate}`)
          let key = parseInt(mbrDate)
          data[key] = parseFloat(data[key]) + parseFloat(mbrPackage)
          dataCount[key] = dataCount[key] + 1
        }

        if (save) {
          rebateMbrLs.push({mbrName: $(rebateMbrNameId).val(), mbrDate: mbrDate})
          if (isNaN(mbrPackage))
            mbrPackage = null
          rebatePackageLs.push(mbrPackage)
        }
      }

      for (k in data) {
        let mbrPackage = data[k]
        $(`#rebate-subtotal-${i}-${k}-count`).html(dataCount[k])
        $(`#rebate-subtotal-${i}-${k}-total`).html(floatToString(mbrPackage))
        $(`#rebate-subtotal-${i}-${k}`).html(floatToString(mbrPackage * i / 100, 2))
      }

      if (save) {
        ipcRenderer.send('set-rebate-mbr', rebateMbrSave)
        ipcRenderer.send('set-rebate-package', rebatePackageSave)
      }

      updTotal()
    }

    function updTotal() {
      for (let k=10; k<=30; k+=10) {
        let count = 0
        let total = 0
        for (let i=1; i<=3; i++) {
          count += parseInt($(`#rebate-subtotal-${i}-${k}-count`).html())
          total += parseFloat($(`#rebate-subtotal-${i}-${k}`).html())
        }
        $(`#rebate-total-${k}-count`).html(count)
        $(`#rebate-total-${k}`).html(floatToString(total, 2))
      }
    }

    ipcRenderer.on('get-mbr', (evt, mbr) => {
      for (key in map)
        $(`#${map[key]}`).html(mbr[key])
    })

    ipcRenderer.on('ls-rebate-mbr', (evt, rebateMbr) => {
      let {mbr_id, mbrPct, mbr} = rebateMbr
      let i = mbrPct
      for (let j=0; j<30; j++) {
        let mbrDate = mbr[j].mbrDate
        if (mbrDate !== null)
          selectMbrDate(i, j, mbrDate)
        $(`#rebate-mbr-name-${i}-${j}`).val(mbr[j].mbrName)
      }
      updSubtotal(i, false)
    })

    ipcRenderer.on('ls-rebate-package', (evt, rebatePackage) => {
      let {mbr_id, mbrPct, mbrPackage} = rebatePackage
      let i = mbrPct
      for (let j=0; j<30; j++)
        $(`#rebate-mbr-package-${i}-${j}`).val(floatToString(mbrPackage[j], 2))
      updSubtotal(i, false)
    })

    ipcRenderer.on('ls-rebate-package-no-data', (evt, i) => {
      updSubtotal(i, false)
    })

    window.onload = function () {
      ipcRenderer.send('get-mbr', _id)
      ipcRenderer.send('ls-rebate', _id)
    }
  </script>

</head>

<body>
  <div id="mbr-navibar">
    <!-- INSERT NAVI BAR -->
  </div>
  <script>
    $('#mbr-navibar').html(`
      <ul class="nav nav-tabs nav-justified">
        <li><a href="mbr-info.html?_id=${_id}">Info</a></li>
        <li class="active"><a href="">Calculator</a></li>
      </ul>`)
  </script>

  <form class="form-horizontal" id="rebate-mbr-info">
    <!-- INSERT MBR INFO ELEMENTS HERE -->
  </form>
  <script>
    let mbrInfoElementMap = [
      {label: 'Name', id: 'mbr-name'},
      {label: 'Email', id: 'mbr-email'},
      {label: 'Bank Name', id: 'mbr-bank-name'},
      {label: 'Bank Acc', id: 'mbr-bank-acc'},
      {label: 'Package', id: 'mbr-package'}
    ]
    let rebateMbrInfo = $('#rebate-mbr-info')
    for ({label, id} of mbrInfoElementMap) {
      rebateMbrInfo.append(`
      <div class="form-group">
        <label class="control-label col-sm-2" for="${id}-lbl">${label}:</label>
          <div class="col-sm-10" id="${id}-lbl">
            <div class="form-control no-input-box" id="${id}">Loading...<!-- INSERT MBR INFO --></div>
          </div>
      </div>`)
    }
  </script>

  <div id="rebate-panels">
    <!-- INSERT 3 PANELS -->
  </div>
  <script>
    let rebatePanels = $('#rebate-panels')
    for (let i=3; i>=1; i--) {
      let rebatePanelHeadId = `rebate-panel-head-${i}`
      let rebatePanelBodyId = `rebate-panel-body-${i}`
      rebatePanels.append(`
        <div class="panel panel-default">
          <div class="panel-heading rebate-panel-head" id="${rebatePanelHeadId}">
            <h3 class="panel-title">${i}%</h3>
          </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-md-9 rebate-panel-body-col no-wrap" id="${rebatePanelBodyId}">
                <!-- INSERT MBR-LS HERE -->
              </div>
              <div class="col-md-3 rebate-panel-body-col">
                <table class="table table-bordered rebate-panel-subtotal">
                  <thead>
                    <tr>
                      <th>
                        <span>10</span>
                        <span id="rebate-subtotal-${i}-10-count" class="label label-danger">0</span>
                      </th>
                      <th>
                        <span>20</span>
                        <span id="rebate-subtotal-${i}-20-count" class="label label-success">0</span>
                      </th>
                      <th>
                        <span>30</span>
                        <span id="rebate-subtotal-${i}-30-count" class="label label-primary">0</span>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><span id="rebate-subtotal-${i}-10-total">0</span></td>
                      <td><span id="rebate-subtotal-${i}-20-total">0</span></td>
                      <td><span id="rebate-subtotal-${i}-30-total">0</span></td>
                    </tr>
                    <tr>
                      <td><span id="rebate-subtotal-${i}-10">0</span></td>
                      <td><span id="rebate-subtotal-${i}-20">0</span></td>
                      <td><span id="rebate-subtotal-${i}-30">0</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>`)
      
      $(`#${rebatePanelHeadId}`).click(rebatePanelBodyId, function(evt) { //can use dblclick 
        $(`#${evt.data}`).toggleClass('wrap no-wrap')
      })
    }

    rebatePanels.append(`
      <div class="panel panel-default rebate-panel-total-panel">
        <div class="panel-body">
          <div class="row">
            <div class="col-md-9 rebate-panel-body-col"></div>
            <div class="col-md-3 rebate-panel-body-col">
              <table class="table table-bordered rebate-panel-total">
                <thead>
                  <tr>
                    <th>
                      <span>10</span>
                      <span id="rebate-total-10-count" class="label label-danger">0</span>
                    </th>
                    <th>
                      <span>20</span>
                      <span id="rebate-total-20-count" class="label label-success">0</span>
                    </th>
                    <th>
                      <span>30</span>
                      <span id="rebate-total-30-count" class="label label-primary">0</span>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><span id="rebate-total-10">0</span></td>
                    <td><span id="rebate-total-20">0</span></td>
                    <td><span id="rebate-total-30">0</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>`)


    for (let i=3; i>=1; i--) {
      let rebatePanelBody = $(`#rebate-panel-body-${i}`)
      let rebateMbrHtml = ''
      for (let j=0; j<30; j++) {
        let rebateMbrDateId = `rebate-mbr-date-${i}-${j}`
        let rebateMbrNameId = `rebate-mbr-name-${i}-${j}`
        let rebateMbrPackageId = `rebate-mbr-package-${i}-${j}`
        rebateMbrHtml += `
          <li>
            <ul class="list-group" id="rebate-mbr-${i}-${j}">
              <li class="list-group-item">
                <div class="btn-group" data-toggle="buttons">
                  <label class="btn btn-default">
                    <input type="checkbox" name="${rebateMbrDateId}" val="10" i="${i}">10
                  </label>
                  <label class="btn btn-default">
                    <input type="checkbox" name="${rebateMbrDateId}" val="20" i="${i}">20
                  </label>
                  <label class="btn btn-default">
                    <input type="checkbox" name="${rebateMbrDateId}" val="30" i="${i}">30
                  </label>
                </div>
              </li>

              <li class="list-group-item">
                <input class="cnt-input" placeholder="Name" id="${rebateMbrNameId}" i="${i}">
              </li>

              <li class="list-group-item">
                <input class="cnt-input" placeholder="Package" type="number" id="${rebateMbrPackageId}" i="${i}">
              </li>
            </ul>
          </li>`
      }
      rebatePanelBody.html(`<ul class="cnt-ul">${rebateMbrHtml}</ul>`)
    }

    for (let i=3; i>=1; i--) {
      for (let j=0; j<30; j++) {
        let rebateMbrPackage = $(`#rebate-mbr-package-${i}-${j}`) 
        rebateMbrPackage.focusout(function(evt) {
          let e = $(this)
          let inp = toFloat(e.val(), 2)
          e.val(floatToString(inp, 2))
          updSubtotal(e.attr('i'), true)
        })
        rebateMbrPackage.keypress(function(evt) {
          if (evt.which == 13)
            $(this).blur()
        })
        rebateMbrPackage.focus(function(){
          this.select()
        })

        let rebateMbrName = $(`#rebate-mbr-name-${i}-${j}`) 
        rebateMbrName.focusout(function(evt) {
          updSubtotal(rebateMbrName.attr('i'), true)
        })
        rebateMbrName.keypress(function(evt) {
          if (evt.which == 13)
            $(this).blur()
        })
         
        let rebateMbrDatesId = `input:checkbox[name="rebate-mbr-date-${i}-${j}"]`
        $(rebateMbrDatesId).change({i: i, j: j}, function(evt) {
          let selectedVal = $(this).attr('val')
          selectMbrDate(evt.data.i, evt.data.j, selectedVal)
          updSubtotal($(this).attr('i'), true)
        })
      }
    }
  </script>

</body>

</html>